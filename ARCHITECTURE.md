# ğŸ—ï¸ Architecture - The Village Project

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ğŸŒ BROWSER (localhost:3000)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                  React Frontend                       â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ Resource â”‚  â”‚  Village â”‚  â”‚    Components    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  Panel   â”‚  â”‚   Grid   â”‚  â”‚  â€¢ Tile          â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ ğŸªµ ğŸª¨ ğŸŒ¾ â”‚  â”‚  Rendererâ”‚  â”‚  â€¢ Tree          â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚         â”‚             â”‚                 â”‚            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â”‚             â”‚                 â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚             â”‚                 â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                    HTTP/REST API
                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                ğŸ Flask Backend (localhost:5000)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    app.py (Router)                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ /api/grid  â”‚  â”‚/api/tree/  â”‚  â”‚ /api/tiles/  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚            â”‚  â”‚   cut      â”‚  â”‚  generate    â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚             â”‚              â”‚              â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  GridManager    â”‚ â”‚   State    â”‚ â”‚  FreepikAPI     â”‚  â”‚
â”‚  â”‚  â€¢ 40x40 Grid   â”‚ â”‚  Manager   â”‚ â”‚  â€¢ Tile Gen     â”‚  â”‚
â”‚  â”‚  â€¢ Tree System  â”‚ â”‚  â€¢ Wood    â”‚ â”‚  â€¢ Sprite Gen   â”‚  â”‚
â”‚  â”‚  â€¢ Tile Types   â”‚ â”‚  â€¢ Stone   â”‚ â”‚                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â€¢ Food    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â”‚ (optional)
                          â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚   ğŸ¨ Freepik API       â”‚
               â”‚   (Tile Generation)    â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow

### 1. Grid Initialization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     GET /api/grid     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  React   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚  Flask       â”‚
â”‚  Grid    â”‚                       â”‚  Backend     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                     â”‚
     â”‚                                     â–¼
     â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                           â”‚  GridManager    â”‚
     â”‚                           â”‚  â€¢ Generate 40x40â”‚
     â”‚                           â”‚  â€¢ Place trees   â”‚
     â”‚                           â”‚  â€¢ Assign types  â”‚
     â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                     â”‚
     â”‚         Grid State JSON             â”‚
     â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Render 1600 tiles       â”‚
â”‚  with tree overlays      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. Tree Cutting Flow

```
User clicks tree (x: 10, y: 15, tree_id: 42)
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Tree.jsx           â”‚
â”‚  onClick handler    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ POST /api/tree/cut
          â”‚ {x: 10, y: 15, tree_id: 42}
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Flask Backend              â”‚
â”‚  â€¢ Find tile at (10, 15)    â”‚
â”‚  â€¢ Find tree with ID 42     â”‚
â”‚  â€¢ Mark tree as cut         â”‚
â”‚  â€¢ Add wood (5-15 units)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ Response: {success: true, wood_gained: 12}
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  React State Update         â”‚
â”‚  â€¢ Mark tree as cut         â”‚
â”‚  â€¢ Update resource counter  â”‚
â”‚  â€¢ Re-render grid           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Component Hierarchy

```
App.jsx
â”œâ”€â”€ ResourcePanel
â”‚   â””â”€â”€ Resource Items (Wood, Stone, Food)
â”‚
â””â”€â”€ VillageGrid
    â”œâ”€â”€ Viewport Manager
    â”œâ”€â”€ Pan Controls
    â””â”€â”€ Tiles (filtered by viewport)
        â””â”€â”€ Tile (for each grid position)
            â”œâ”€â”€ Background (colored by type)
            â””â”€â”€ Trees (1-2 per tile)
                â””â”€â”€ Tree
                    â”œâ”€â”€ Emoji/Image
                    â””â”€â”€ Click Handler
```

---

## State Management

### Backend State (grid_manager.py)

```python
{
  "grid": {
    "0,0": {
      "x": 0,
      "y": 0,
      "tile_type": "grass",
      "tile_image_url": null,
      "trees": [
        {
          "id": 0,
          "position": {"offset_x": 0.7, "offset_y": 0.3},
          "cut": false,
          "type": "oak"
        }
      ]
    },
    # ... 1599 more tiles
  },
  "resources": {
    "wood": 0,
    "stone": 0,
    "food": 0
  }
}
```

### Frontend State (VillageGrid.jsx)

```javascript
{
  tiles: [...],           // Array of tile objects
  resources: {...},       // Resource counts
  pan: {x: 0, y: 0},     // Camera position
  isDragging: false,     // Pan state
  loading: false         // Load state
}
```

---

## Grid System

### Tile Distribution (40Ã—40 = 1,600 tiles)

| Tile Type | Probability | Count | Trees |
|-----------|-------------|-------|-------|
| Grass     | 70%         | ~1120 | 70% have 1-2 trees |
| Dirt      | 15%         | ~240  | 70% have 1-2 trees |
| Forest    | 10%         | ~160  | Always 1-2 trees |
| Water     | 5%          | ~80   | No trees |

**Expected Total Trees**: ~1,000-1,400 trees

### Tile Coordinates

```
    0     1     2    ...   39
  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
0 â”‚ ğŸŒ³  â”‚     â”‚ ğŸŒ²  â”‚...â”‚     â”‚
  â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
1 â”‚     â”‚ ğŸŒ³ğŸŒ´â”‚     â”‚...â”‚ ğŸŒ²  â”‚
  â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
2 â”‚ ğŸŒ²  â”‚     â”‚ ğŸŒ³  â”‚...â”‚     â”‚
  â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
...
  â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤
39â”‚     â”‚ ğŸŒ³  â”‚     â”‚...â”‚ ğŸŒ²  â”‚
  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜

Each cell = 64Ã—64 pixels
Total dimensions = 2,560Ã—2,560 pixels
```

---

## Performance Optimizations

### 1. Viewport Culling

Only render tiles visible in viewport:

```javascript
// Calculate visible range
startX = Math.floor(-pan.x / TILE_SIZE)
startY = Math.floor(-pan.y / TILE_SIZE)
endX = Math.ceil((viewportWidth - pan.x) / TILE_SIZE)
endY = Math.ceil((viewportHeight - pan.y) / TILE_SIZE)

// Filter tiles
visibleTiles = tiles.filter(tile => 
  tile.x >= startX && tile.x < endX &&
  tile.y >= startY && tile.y < endY
)
```

**Result**: Renders ~100-200 tiles instead of 1,600

### 2. CSS Grid Layout

Uses native CSS Grid for efficient positioning:

```css
.village-grid {
  display: grid;
  grid-template-columns: repeat(40, 64px);
  grid-auto-rows: 64px;
}

.tile {
  grid-column: x + 1;
  grid-row: y + 1;
}
```

### 3. React Optimization

- Memoized viewport calculation
- Debounced pan updates
- Key-based reconciliation

---

## API Contract

### GET `/api/grid`

**Response:**
```json
{
  "grid_size": 40,
  "tiles": [...],
  "resources": {"wood": 0, "stone": 0, "food": 0},
  "stats": {
    "total_trees": 1234,
    "trees_cut": 56
  }
}
```

### POST `/api/tree/cut`

**Request:**
```json
{
  "x": 10,
  "y": 15,
  "tree_id": 42
}
```

**Response:**
```json
{
  "success": true,
  "wood_gained": 12,
  "total_resources": {"wood": 12, "stone": 0, "food": 0}
}
```

---

## Extensibility Points

### Adding New Resource Types

1. Update `GridManager.resources` dict
2. Add resource to `ResourcePanel.jsx`
3. Create gather endpoint (e.g., `/api/stone/mine`)

### Adding New Tile Types

1. Add type to `_random_tile_type()` in `grid_manager.py`
2. Add color mapping in `Tile.jsx`
3. Add Freepik prompt in `freepik_api.py`

### Adding Buildings

1. Add `buildings` array to tile schema
2. Create `Building.jsx` component
3. Add `/api/building/construct` endpoint

---

## Future Architecture (Phase 2+)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend (React)                           â”‚
â”‚  â€¢ Grid Renderer                            â”‚
â”‚  â€¢ Agent Visualizer â† NEW                   â”‚
â”‚  â€¢ Conversation Log â† NEW                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Flask Orchestrator                         â”‚
â”‚  â€¢ Tick Loop (every 20-30s) â† NEW          â”‚
â”‚  â€¢ Grid API                                 â”‚
â”‚  â€¢ Agent API â† NEW                          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚       â”‚       â”‚
       â”‚       â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚       â”‚                      â”‚
       â”‚       â–¼                      â–¼
       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚  â”‚  Fastino    â”‚     â”‚   Airia      â”‚
       â”‚  â”‚  (Memory)   â”‚     â”‚  (Workflows) â”‚
       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase/   â”‚
â”‚  Postgres    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

Built for autonomous AI simulation ğŸ¤–ğŸŒ³

